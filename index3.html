<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title> Создание программы для разбора выражений </title>
    <script type="text/javascript" src="d3.min.js"></script>
  </head>
  <body> <!--style ="background-color: yellow;"/-->
    <!--<script>alert("bla");</script-->
    <h1 style ="color: blue"> Проектная работа по предмету "Компьютерная алгебра".</h1>
    <h2 style ="color: red"> Выполнила: студентка 472 группы Комиссарова Дарья.</h2>
    <h3 style ="color: red"> Для создания работы использован язык Java Script</h3>
    <h3 style ="color: black"> Программа осуществляет синтаксический разбор рациональных выражений.</h3>
    <h3 style ="color: black"> При вводе выражений разрешается использовать цифры, цифры с точкой (5. или .01 - не разрешены.), знаки +, -, *, /, скобки (, ).</h3>
    <form>
    <table>
      <tr>
      <td>Введите выражение</td>
      <td><input name="in_form" type="text" id="textbox"></td>
      <td><input type="button" value="Произвести разбор"  id ="buttoncheck"/></td>
      </tr>
    </table>
    </form>
    <script language="javascript" type="text/javascript">
    var widthCanvas = 900;
    var heightCanvas = 500;
    var heightPath = 70;
    Object.prototype.paint=function(xCorner, yCorner, part){
      d3.select("svg").append("circle")
      .attr("cx", xCorner-15)
      .attr("cy", yCorner-15)
      .attr("r", 15)
      .attr("fill-opacity", 0)
      .attr("stroke", "red")
      .attr("fill", "white");
      var stroka = this.key;
      d3.select("svg").append("text")
      .attr("x", xCorner-15-9)
      .attr("y", yCorner-15+5)
      .text(function (d){return stroka;});
      if (this.left != undefined) {
        d3.select("svg").append("path")
        .attr("d","M"+(xCorner-15)+" "+yCorner+" L"+(xCorner-widthCanvas/part-15)+" "+(yCorner+heightPath-30)+"Z");
        this.left.paint(xCorner-widthCanvas/part, yCorner+heightPath, part*2);
      }
      if (this.right != undefined) {
        d3.select("svg").append("path")
        .attr("d","M"+(xCorner-15)+" "+yCorner+" L"+(xCorner+widthCanvas/part-15)+" "+(yCorner+heightPath-30)+"Z");
        this.right.paint(xCorner+widthCanvas/part, yCorner+heightPath, part*2);
      }
    }
    var elemButton = document.getElementById('buttoncheck');
    var elemTextbox = document.getElementById('textbox');
    
  
  var arr= new Array();
  var k=0;
  var flagError='';
  elemButton.onclick=function() {
    try {
      arr= new Array();
      k=0;
      flagError='';
    
      read(elemTextbox.value+'#');
      
      
      var tree = parseA(arr);
      
      if (arr[k]!='#')
        throw new Error("Встречен неподходящий символ (или не на правильной позиции). Исправьте выражение.");
      else if (k!=arr.length-1)
        throw new Error("Не дошли до конца выражения. Проверьте правильность введенных данных.");
              
      d3.selectAll("svg").remove();
      d3.select("body").append("svg")
        .attr("stroke", "black")
        .attr("height", heightCanvas)
        .attr("width", widthCanvas)
        .attr("viewBox", "100 300 "+widthCanvas+" "+ heightCanvas)
        .attr("border-style", "double");
      tree.paint(100+widthCanvas/2, 300+100, 4);
      
    } catch (err) {
      d3.selectAll("svg").remove();
      alert(err.message); 
    }
    }
  
  
    function read(initialString){
      var i=0;
      //var sign = 1;
      var status='S';
      var temp='';
      while (i<initialString.length) {
        switch (status) {
          case 'S': {
            if (initialString[i]>='0' && initialString[i]<='9') {
              temp=temp+initialString[i];
              status='A';
            }
            else if (initialString[i]=='(' || initialString[i]==')' || initialString[i]=='+' || initialString[i]=='-' || initialString[i]=='*' || initialString[i]=='/' || initialString[i]=='#') {
              arr.push(initialString[i]);
              temp='';
              status='S';
            }
      else if (initialString[i]=='.')
        throw new Error("Неправильное выражение с '.' . Не хватает числа перед ней. ");
      else {
         throw new Error("Недопустимые символы. Исправьте выражение.");
      }
            i++;
            break;
            }
          case 'A': {
            if (initialString[i]>='0' && initialString[i]<='9') {
              temp=temp+initialString[i];
              status='A';
              i++;
            }
            else if (initialString[i]=='.') {
              temp=temp+initialString[i];
              i++;
              if (initialString[i]>='0' && initialString[i]<='9') {
                temp=temp+initialString[i];
                status='B';
                i++;
              }
              else {
               // alert("Должна быть цифра после точки");
                throw new Error("Ошибка при постановке числа с точкой!"); //!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
              }
              }
            else {
              arr.push(temp);
              status='S';
            }
            break;
            }
          case 'B': {
            if (initialString[i]>='0' && initialString[i]<='9') {
              temp=temp+initialString[i];
              status='B';
              i++;
            }
            else {
              arr.push(temp);
              status='S';
            }
            }
        }
      }
    
    }  
      // грамматика
      /*
      A->{+-}EB
      B->+-*:EB|e
      E->число|(A)
      */
    function parseA(arr){
      if (arr[k]=='+' || arr[k]=='-') {
        var sign={key: arr[k]};
        sign.type='sign';
        k++;
        sign.left=parseE(arr);
        return parseB(arr,parseC(arr,sign));
      }
      else 
        return parseB(arr,parseC(arr,parseE(arr)));
    }
    function parseB(arr,left){
      if (arr[k]=='+' || arr[k]=='-') {
        var sign={key: arr[k]};
        sign.type='sign';
        sign.left=left;
        k++;
        sign.right=parseC(arr,parseE(arr));
        return parseB(arr,sign);
      }
      else 
        return left;
    }
    function parseC(arr,left){
      if (arr[k]=='*' || arr[k]=='/') {
        var sign={key: arr[k]};
        sign.left=left;
        k++;
        sign.right=parseE(arr);
        return parseC(arr,sign);
      }
      else 
        return left;
    }
    function parseE(arr){
      if (arr[k]>='0' && arr[k]<='9'){
        k++;
        return {key: arr[k-1] }; 
      }
      else if (arr[k]=='(') {
        k++;
        var temp=parseA(arr);
        //k++;
        if (arr[k]==')') 
          k++;
        else {
          //flagError='Не хватает закрывающейся скобки';
          throw new Error("Не хватает закрывающейся скобки");
        }
        return temp;
      }
      else 
        //flagError ='Что-то не то с E';
    throw new Error("Должно быть число или откр. скобка");
    }
    </script>
  </body>
</html>